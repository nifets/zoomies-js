<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoomies.js Test Networks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        #graph-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: white;
        }

        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            font-size: 12px;
        }

        button {
            display: block;
            margin: 5px 0;
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            font-size: 12px;
        }

        button:hover {
            background: #764ba2;
        }

        button.active {
            background: #2ecc71;
        }

        .label {
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <canvas id="graph-canvas"></canvas>
    
    <div id="controls">
        <div style="margin-bottom: 10px; font-weight: bold;">Gene Regulation Network</div>
        <button class="layer-btn active" data-layers="0">Layer 0 Only</button>
        <button class="layer-btn" data-layers="0,1">Layers 0-1</button>
        <button class="layer-btn" data-layers="0,1,2">All Layers</button>
        
        <button id="physics-btn" class="active" style="margin-top: 10px; background: #27ae60;">Physics: ON</button>
        
        <button id="edge-labels-btn" class="active" style="margin-top: 5px; background: #27ae60;">Edge Labels: ON</button>
        
        <button id="debug-btn" style="margin-top: 5px; background: #e74c3c;">Debug: OFF</button>
        
        <div class="label">
            <div style="margin-top: 10px; font-weight: bold;">Controls</div>
            Scroll: zoom<br>
            Drag: move nodes<br>
            Right-click: pan
        </div>
    </div>

    <script type="module">
        import { Zoomies, Entity, Connection } from './src/index.ts';
        import { CONFIG } from './src/config.ts';

        let currentZoomies = null;
        let edgeLabelsEnabled = true;

        /**
         * Create gene regulation network with:
         * - Layer 0: mRNA_A, Protein_A (within each gene)
         * - Layer 1: Gene A, B, C, D (each containing mRNA + Protein)
         * - Layer 2: Differentiation (containing Gene A and B)
         */
        function createGeneNetwork(maxLayer) {
            // Helper: create mRNA and Protein pair for a gene
            function createGenePair(geneName) {
                const mRNA = new Entity(`mRNA_${geneName}`, { 
                    layer: 0,
                    colour: '#3498db'
                });
                const protein = new Entity(`Protein_${geneName}`, { 
                    layer: 0,
                    colour: '#e74c3c',
                    shape:'rectangle',
                    width: 1.0,
                    height: 1.0
                });
                return { mRNA, protein };
            }

            // Layer 0: Create mRNA and Protein for genes A, B, C, D
            const pairA = createGenePair('A');
            const pairB = createGenePair('B');
            const pairC = createGenePair('C');
            const pairD = createGenePair('D');

            // Layer 0: Translation connections (mRNA â†’ Protein within each gene)
            const connections = [
                new Connection('translation_A', [pairA.mRNA], [pairA.protein], {
                    colour: '#95a5a6',
                    width: 0.8
                }),
                new Connection('translation_B', [pairB.mRNA], [pairB.protein], {
                    colour: '#95a5a6',
                    width: 0.8
                }),
                new Connection('translation_C', [pairC.mRNA], [pairC.protein], {
                    colour: '#95a5a6',
                    width: 0.8
                }),
                new Connection('translation_D', [pairD.mRNA], [pairD.protein], {
                    colour: '#95a5a6',
                    width: 0.8
                }),
                // Inhibition: Protein B inhibits mRNA A
                new Connection('inhibition_B_to_A', [pairB.protein], [pairA.mRNA], {
                    colour: '#e74c3c',
                }),
                // Inhibition: Protein A inhibits mRNA B
                new Connection('inhibition_A_to_B', [pairA.protein], [pairB.mRNA], {
                    colour: '#e74c3c',
                }),
                // Protein B activates mRNA D
                new Connection('activation_B_to_D', [pairB.protein], [pairD.mRNA], {
                    colour: '#2ecc71',
                }),
                // Protein A activates mRNA C
                new Connection('activation_A_to_C', [pairA.protein], [pairC.mRNA], {
                    colour: '#2ecc71',
                })
            ];

            // Entities at layer 0
            const layer0Entities = [
                pairA.mRNA, pairA.protein,
                pairB.mRNA, pairB.protein,
                pairC.mRNA, pairC.protein,
                pairD.mRNA, pairD.protein
            ];

            let layer1Entities = [];
            let layer2Entities = [];
            let allEntities = layer0Entities;

            // Layer 1: Gene entities (only if maxLayer >= 1)
            if (maxLayer >= 1) {
                const geneA = new Entity('Gene_A', {
                    children: [pairA.mRNA, pairA.protein],
                    layer: 1,
                    colour: '#000000',
                    width: 1.4,
                    height: 1.1,
                    cornerRadius: 0.15,
                    shape: 'rectangle'
                });

                const geneB = new Entity('Gene_B', {
                    children: [pairB.mRNA, pairB.protein],
                    layer: 1,
                    colour: '#98FB98',
                    width: 1.4,
                    height: 1.1,
                    cornerRadius: 0.15,
                    shape: 'rectangle'
                });

                const geneC = new Entity('Gene_C', {
                    children: [pairC.mRNA, pairC.protein],
                    layer: 1,
                    colour: '#98FB98',
                    width: 1.2,
                    height: 1.0,
                    cornerRadius: 0.1,
                    shape: 'rectangle'
                });

                const geneD = new Entity('Gene_D', {
                    children: [pairD.mRNA, pairD.protein],
                    layer: 1,
                    colour: '#98FB98',
                    width: 1.2,
                    height: 1.0,
                    cornerRadius: 0.1,
                    shape: 'rectangle'
                });

                layer1Entities = [geneA, geneB, geneC, geneD];
                allEntities = layer0Entities.concat(layer1Entities);

                // Layer 2: Differentiation entity (only if maxLayer >= 2)
                if (maxLayer >= 2) {
                    const differentiation = new Entity('Differentiation', {
                        children: [geneA, geneB],
                        layer: 2,
                        colour: '#fadbd8',
                        shape: 'rectangle',
                        radius: 0.5
                    });

                    layer2Entities = [differentiation];
                    allEntities = layer0Entities.concat(layer1Entities).concat(layer2Entities);
                }
            }

            // Per-layer metadata for visualization
            const layerMetadata = new Map();
            
            layerMetadata.set(0, {
                entityShape: 'circle',
                entityColour: '#3498db',
                edgeColour: '#17a2b8',
                relativeScale: 5
            });

            if (maxLayer >= 1) {
                layerMetadata.set(1, {
                    entityShape: 'circle',
                    entityColour: '#2ecc71',
                    edgeColour: '#e67e22',
                    relativeScale: 3
                });
            }

            if (maxLayer >= 2) {
                layerMetadata.set(2, {
                    entityShape: 'circle',
                    entityColour: '#9b59b6',
                    edgeColour: '#e91e63'
                });
            }

            return {
                entities: allEntities,
                connections: connections,
                layerMetadata: layerMetadata
            };
        }

        // Initialize network with given max layer
        function initializeNetwork(maxLayer) {
            if (currentZoomies) {
                currentZoomies.destroy();
                const oldCanvas = document.getElementById('graph-canvas');
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'graph-canvas';
                newCanvas.style.cssText = oldCanvas.style.cssText;
                oldCanvas.replaceWith(newCanvas);
            }

            const network = createGeneNetwork(maxLayer);
            
            const options = {
                enablePhysics: true,
                layerDetailConfig: {
                    layerScaleFactor: 3,
                    layerMetadata: network.layerMetadata
                },
                renderConfig: {
                    showEdgeLabels: edgeLabelsEnabled
                }
            };
            
            currentZoomies = new Zoomies('#graph-canvas', network.entities, network.connections, options);

            // Show debug widget
            currentZoomies.showZoomDebug();

            // Update button states
            document.querySelectorAll('.layer-btn').forEach(btn => {
                const layers = btn.dataset.layers;
                const maxLayer = Math.max(...layers.split(',').map(Number));
                btn.classList.toggle('active', maxLayer === maxLayer);
            });

            console.log(`[Demo] Loaded network with max layer: ${maxLayer}`);
            console.log(`[Demo] Entities: ${network.entities.length}, Connections: ${network.connections.length}`);
        }

        // Layer button handlers
        document.querySelectorAll('.layer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const layers = btn.dataset.layers.split(',').map(Number);
                const maxLayer = Math.max(...layers);
                initializeNetwork(maxLayer);
                
                document.querySelectorAll('.layer-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            });
        });

        // Physics toggle
        let physicsEnabled = true;
        document.getElementById('physics-btn').addEventListener('click', () => {
            const btn = document.getElementById('physics-btn');
            if (physicsEnabled) {
                currentZoomies.disablePhysics();
                physicsEnabled = false;
                btn.textContent = 'Physics: OFF';
                btn.classList.remove('active');
                btn.style.background = '#e74c3c';
            } else {
                currentZoomies.enablePhysics();
                physicsEnabled = true;
                btn.textContent = 'Physics: ON';
                btn.classList.add('active');
                btn.style.background = '#27ae60';
            }
        });

        // Edge labels toggle
        document.getElementById('edge-labels-btn').addEventListener('click', () => {
            const btn = document.getElementById('edge-labels-btn');
            edgeLabelsEnabled = !edgeLabelsEnabled;
            if (edgeLabelsEnabled) {
                btn.textContent = 'Edge Labels: ON';
                btn.classList.add('active');
                btn.style.background = '#27ae60';
            } else {
                btn.textContent = 'Edge Labels: OFF';
                btn.classList.remove('active');
                btn.style.background = '#e74c3c';
            }
            // Reinitialize network with new config
            const layers = document.querySelector('.layer-btn.active').dataset.layers.split(',').map(Number);
            const maxLayer = Math.max(...layers);
            initializeNetwork(maxLayer);
        });

        // Debug toggle
        document.getElementById('debug-btn').addEventListener('click', () => {
            const btn = document.getElementById('debug-btn');
            CONFIG.DEBUG = !CONFIG.DEBUG;
            if (CONFIG.DEBUG) {
                btn.textContent = 'Debug: ON';
                btn.classList.add('active');
                btn.style.background = '#2ecc71';
            } else {
                btn.textContent = 'Debug: OFF';
                btn.classList.remove('active');
                btn.style.background = '#e74c3c';
            }
            console.log(`[Demo] Debug mode: ${CONFIG.DEBUG}`);
        });

        // Initialize with layer 0 only
        initializeNetwork(0);
    </script>
</body>
</html>
